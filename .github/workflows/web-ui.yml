name: Web UI CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    name: Build & Verify
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: web

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Verify build output
        run: |
          if [ ! -d "dist" ]; then
            echo "::error::Build output directory 'dist' not found"
            exit 1
          fi

          INDEX=$(find dist -name "index.html" | head -1)
          if [ -z "$INDEX" ]; then
            echo "::error::index.html not found in build output"
            exit 1
          fi

          JS_COUNT=$(find dist -name "*.js" | wc -l)
          CSS_COUNT=$(find dist -name "*.css" | wc -l)

          echo "Build output:"
          echo "  index.html: $INDEX"
          echo "  JS files: $JS_COUNT"
          echo "  CSS files: $CSS_COUNT"
          du -sh dist

          if [ "$JS_COUNT" -eq 0 ]; then
            echo "::error::No JS files in build output"
            exit 1
          fi

          echo "Build verification passed."

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: build

    defaults:
      run:
        working-directory: web

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Start preview server
        run: |
          npm run build
          npx vite preview --port 4173 --host &
          echo "PREVIEW_PID=$!" >> $GITHUB_ENV

      - name: Wait for healthy
        run: |
          for i in $(seq 1 15); do
            if curl -sf http://localhost:4173 > /dev/null 2>&1; then
              echo "Preview server is healthy"
              exit 0
            fi
            echo "Waiting... ($i/15)"
            sleep 2
          done
          echo "Preview server did not become healthy"
          exit 1

      - name: Verify page loads
        run: |
          echo "=== HTTP Status ==="
          STATUS=$(curl -o /dev/null -s -w "%{http_code}" http://localhost:4173)
          echo "Status: $STATUS"
          if [ "$STATUS" != "200" ]; then
            echo "::error::Expected 200, got $STATUS"
            exit 1
          fi

          echo "=== Page Content ==="
          BODY=$(curl -s http://localhost:4173)
          if echo "$BODY" | grep -q '<div id="root"'; then
            echo "React root element found."
          else
            echo "::error::React root element not found in page"
            exit 1
          fi

          echo "Health check passed."

      - name: Stop preview server
        if: always()
        run: kill $PREVIEW_PID 2>/dev/null || true
