# ─── Contextify All-in-One Docker Image ───
# Includes: PostgreSQL 16 + pgvector, Ollama, nomic-embed-text model, Go server, Web UI
# Usage: docker run -d -p 8420:8420 -v pgdata:/var/lib/postgresql/data contextify

# ── Stage 1: Build Web UI ──
FROM node:22-alpine AS web-builder

WORKDIR /web
COPY web/package.json web/package-lock.json* ./
RUN npm install
COPY web/ .
RUN npm run build

# ── Stage 2: Build Go Binary ──
FROM golang:1.23-alpine AS go-builder

ARG VERSION=dev

WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build \
    -ldflags="-s -w -X main.version=${VERSION}" \
    -o /contextify ./cmd/server

# ── Stage 3: Runtime (All-in-One) ──
FROM pgvector/pgvector:pg16

LABEL org.opencontainers.image.title="Contextify" \
      org.opencontainers.image.description="All-in-one AI agent memory system — PostgreSQL, Ollama, MCP Server, REST API, Web UI" \
      org.opencontainers.image.source="https://github.com/atakanatali/contextify" \
      org.opencontainers.image.licenses="MIT"

# Install runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    tzdata \
    && rm -rf /var/lib/apt/lists/*

# Install Ollama
RUN curl -fsSL https://ollama.com/install.sh | sh

# Pre-pull nomic-embed-text model at build time (~274MB baked into image)
RUN ollama serve & \
    SERVER_PID=$! && \
    sleep 3 && \
    for i in $(seq 1 30); do \
        curl -sf http://127.0.0.1:11434/api/tags >/dev/null 2>&1 && break; \
        sleep 1; \
    done && \
    ollama pull nomic-embed-text && \
    kill $SERVER_PID && \
    wait $SERVER_PID 2>/dev/null || true

# Copy Go binary and web assets
COPY --from=go-builder /contextify /usr/local/bin/contextify
COPY --from=web-builder /web/dist /usr/share/contextify/web

# Copy entrypoint
COPY docker/entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# PostgreSQL data is the only volume needed — everything else is baked in
VOLUME ["/var/lib/postgresql/data"]

EXPOSE 8420

HEALTHCHECK --interval=10s --timeout=5s --start-period=30s --retries=3 \
    CMD curl -sf http://localhost:8420/health || exit 1

ENTRYPOINT ["/entrypoint.sh"]
